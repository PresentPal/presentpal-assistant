<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Your Gift List | PresentPal</title>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon.png">

   <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f9f9f9;
      color: #333;
      text-align: center;
    }
    h1 {
      margin-bottom: 20px;
    }
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      align-items: center;
      margin-bottom: 20px;
    }
    .filter-bar input,
    .filter-bar select {
      padding: 10px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 220px;
      max-width: 90%;
    }
    .product {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin: 10px;
      padding: 15px;
      width: 250px;
      height: 360px;
      display: inline-flex;
      flex-direction: column;
      justify-content: space-between;
      text-align: center;
      box-sizing: border-box;
    }
    .product img {
      width: 100%;
      height: 180px;
      object-fit: contain;
      border: none;
    }
    .product h3 {
      font-size: 14px;
      margin: 10px 0 0;
      line-height: 1.2em;
      max-height: 2.4em;
      overflow: hidden;
    }
    .product a {
      display: inline-block;
      margin-top: 10px;
      padding: 10px 16px;
      background-color: #007bff;
      color: white;
      border-radius: 6px;
      font-weight: bold;
      text-decoration: none;
      transition: background-color 0.3s ease;
    }
    .product a:hover {
      background-color: #0056b3;
    }
    .pagination {
      margin-top: 30px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    .pagination button {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .pagination button:hover {
      background-color: #0056b3;
    }
    .pagination button.active {
      background: #0056b3;
      font-weight: bold;
    }
    .pagination button:disabled {
      background: #ccc;
      cursor: default;
    }
    #productContainer.fade-out {
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    #productContainer.fade-in {
      opacity: 1;
      transition: opacity 0.3s ease;
    }
  </style>
</head>
<body>
  <h1>Find the Perfect Gift</h1>

  <div class="filter-bar">
    <input type="text" id="searchInput" placeholder="Search products..." />
    <select id="mainCategoryFilter">
      <option value="">Filter by Main Category</option>
    </select>
    <select id="subCategoryFilter">
      <option value="">Filter by Subcategory</option>
    </select>
  </div>

  <div id="productContainer"></div>
  <div class="pagination" id="paginationControls"></div>

<script>
let allProducts = [];
let filteredProducts = [];
let currentPage = 1;
const itemsPerPage = 24;

const categoryMapping = {
  "DIY & Renovations": ["Air Tools & Compressors", "Adhesives, Sealants & Fillers", "Building Materials & Chemicals"]
};

function getCategoryLabels(merchantCategory) {
  for (const [main, subs] of Object.entries(categoryMapping)) {
    for (const sub of subs) {
      if (merchantCategory.includes(sub)) {
        return { mainCategory: main, subCategory: sub };
      }
    }
  }
  return { mainCategory: "Other", subCategory: "Uncategorized" };
}

function fetchProducts(page = 1) {
  const url = `https://evening-basin-64817-f38e98d8c5e2.herokuapp.com/products.json?page=${page}&limit=${itemsPerPage}`;
  fetch(url)
    .then(res => res.json())
    .then(data => {
      allProducts = data.map(p => {
        const { mainCategory, subCategory } = getCategoryLabels(p.category || "");
        return { ...p, mainCategory, subCategory };
      });
      populateCategoryFilters();
      applyFilters();
    })
    .catch(err => console.error("Error fetching products:", err));
}

function populateCategoryFilters() {
  const mainSelect = document.getElementById("mainCategoryFilter");
  const subSelect = document.getElementById("subCategoryFilter");

  const mains = new Set(allProducts.map(p => p.mainCategory));
  mainSelect.innerHTML = '<option value="">Filter by Main Category</option>';
  mains.forEach(m => {
    const opt = document.createElement("option");
    opt.value = m; opt.textContent = m;
    mainSelect.appendChild(opt);
  });

  const subs = new Set(allProducts.map(p => p.subCategory));
  subSelect.innerHTML = '<option value="">Filter by Subcategory</option>';
  subs.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s; opt.textContent = s;
    subSelect.appendChild(opt);
  });
}

function applyFilters() {
  const keyword = document.getElementById("searchInput").value.toLowerCase();
  const main = document.getElementById("mainCategoryFilter").value;
  const sub = document.getElementById("subCategoryFilter").value;

  filteredProducts = allProducts.filter(p => {
    const text = `${p.name} ${p.category}`.toLowerCase();
    const matchKeyword = !keyword || text.includes(keyword);
    const matchMain = !main || p.mainCategory === main;
    const matchSub = !sub || p.subCategory === sub;
    return matchKeyword && matchMain && matchSub;
  });

  currentPage = 1;
  displayProducts();
  renderPagination();
}

document.getElementById("searchInput").addEventListener("input", applyFilters);
document.getElementById("mainCategoryFilter").addEventListener("change", applyFilters);
document.getElementById("subCategoryFilter").addEventListener("change", applyFilters);

function displayProducts() {
  const container = document.getElementById("productContainer");
  container.innerHTML = "";
  const start = (currentPage - 1) * itemsPerPage;
  const pageProducts = filteredProducts.slice(start, start + itemsPerPage);

  pageProducts.forEach(p => {
    const div = document.createElement("div");
    div.className = "product";

    const img = document.createElement("img");
    img.src = p.image;
    img.alt = p.name;
    img.onerror = function () {
      div.remove(); // Remove the whole card if image fails to load
    };

    const title = document.createElement("h3");
    title.textContent = p.name;

    const link = document.createElement("a");
    link.href = p.link;
    link.target = "_blank";
    link.textContent = "View Product";

    div.appendChild(img);
    div.appendChild(title);
    div.appendChild(link);
    container.appendChild(div);
  });
}

function renderPagination() {
  const pagination = document.getElementById("paginationControls");
  pagination.innerHTML = "";
  const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);

  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement("button");
    btn.textContent = i;
    if (i === currentPage) btn.className = "active";
    btn.onclick = () => { currentPage = i; displayProducts(); renderPagination(); };
    pagination.appendChild(btn);
  }
}

fetchProducts();
</script>
</body>
</html>
