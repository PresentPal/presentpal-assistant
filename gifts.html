<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gift Catalogue</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f9f9f9;
      color: #333;
      text-align: center;
    }

    h1 {
      margin-bottom: 20px;
    }

    /* General Styling for Dropdowns */
select {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background-color: white;
  border: 1px solid #ccc;
  padding: 10px 14px;
  border-radius: 6px;
  font-size: 14px;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  background-image: url("data:image/svg+xml;utf8,<svg fill='gray' height='20' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 16px 16px;
  padding-right: 36px;
}

/* Hover & Focus */
select:hover {
  border-color: #007bff;
}

       /* Main category options (bold) */
select option.main-category {
  font-weight: bold;
  background-color: #f0f0f0;
  color: #333;
}

/* Subcategory options (indented) */
select option.sub-category {
  padding-left: 20px;
}

select:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 2px rgba(0,123,255,0.2);
}

    input[type="file"],
    #searchBar,
    select {
      margin: 10px;
      padding: 10px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    #filters {
      margin-bottom: 20px;
    }
    
    .filter-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  align-items: center;
  margin-bottom: 20px;
}

.filter-bar input,
.filter-bar select {
  padding: 10px;
  font-size: 14px;
  border-radius: 6px;
  border: 1px solid #ccc;
  width: 220px;
  max-width: 90%;
}


    .product {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin: 10px;
      padding: 15px;
      width: 250px;
      height: 360px;
      display: inline-flex;
      flex-direction: column;
      justify-content: space-between;
      text-align: center;
      box-sizing: border-box;
    }

    .product img {
      width: 100%;
      height: 180px;
      object-fit: contain;
      border: none;
    }

    .product h3 {
      font-size: 14px;
      margin: 10px 0 0;
      line-height: 1.2em;
      max-height: 2.4em;
      overflow: hidden;
    }

    .product a {
      display: inline-block;
      margin-top: 10px;
      padding: 10px 16px;
      background-color: #007bff;
      color: white;
      border-radius: 6px;
      font-weight: bold;
      text-decoration: none;
      transition: background-color 0.3s ease;
    }

    .product a:hover {
      background-color: #0056b3;
    }

    .product a.image-link,
    .product a.title-link {
      background: none;
      padding: 0;
      margin: 0;
      text-decoration: none;
      color: inherit;
    }

    .product a.image-link:hover,
    .product a.title-link:hover {
      background: none;
      color: #007bff;
    }

    .pagination {
      margin-top: 30px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
    }

    .pagination button {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .pagination button:hover {
      background-color: #0056b3;
    }

    .pagination button.active {
      background: #0056b3;
      font-weight: bold;
    }

    .pagination button:disabled {
      background: #ccc;
      cursor: default;
    }

    .pagination .ellipsis {
      padding: 8px 10px;
      color: #555;
    }

    #productContainer.fade-out {
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    #productContainer.fade-in {
      opacity: 1;
      transition: opacity 0.3s ease;
    }

  </style>
</head>
<body>
  <h1>Gift Catalogue</h1>
  <input type="file" id="csvFile" accept=".csv" />

  <div class="filter-bar">
    <input type="text" id="searchInput" placeholder="Search products..." />
    <select id="merchantFilter">
      <option value="">Filter by Merchant</option>
    </select>
    <select id="categoryFilter">
      <option value="">Filter by Category</option>
    </select>
  </div>

  <div id="spinner" style="display: none; font-weight: bold; margin: 20px;">Loading products...</div>
  <div id="productContainer"></div>
  <div class="pagination" id="paginationControls"></div>

  <script>
    let allProducts = [];
    let filteredProducts = [];
    let currentPage = 1;
    const itemsPerPage = 24;

    const approvedMerchants = [
      "Theatre Tickets Direct", "Wowow Toys", "Plusshop UK", "Tisserand Aromatherapy", "Game Over",
      "Kaliese", "Uud fragrances", "Tooled Up", "Forever Lily", "Little Women Lingerie",
      "Vistaexpert UK", "My Kind of Cruise", "Sport and Leisure UK", "Webbs Motorcycles",
      "Mafett UK", "Edx Education UK Limited", "Spoiled Brat", "Pott'd UK", "Kokoso Baby",
      "We are Nutrified", "Polaris Bikewear", "T.LUXY", "Cronjager", "Furniture Life",
      "Fishcave Aquatics", "Love Tech Hate Waste", "Vintage Wine Gifts", "OFFSCENT",
      "Simply LED", "MyBeauty.Boutique"
    ];

    const categoryKeywords = {
      "Special Occasions - Mothers Day": ["mother"],
      "Special Occasions - Mummy to be": ["mummy to be"],
      "Special Occasions - Valentine’s gifts": ["valentines", "valentines gifts", "valentine"],
      "Special Occasions - Weddings": ["brides", "bride to be", "bridesmaids"],
      "Special Occasions - Birthday": ["birthday", "bday"],
      "Special Occasions - Halloween": ["halloween"],
      "Special Occasions - Easter": ["easter"],
      "Special Occasions - Christmas": ["christmas", "santa", "snowman", "xmas"],
      "Gifting - Flowers": ["flowers"],
      "Gifting - Candles": ["candle", "candles"],
      "Gifting - Gift Bags": ["gift bag"],
      "Gifting - Cards": ["card"],
      "Health & Beauty - Skincare": ["pigmentation", "rehydrate", "skin", "wrinkles", "collagen", "personal care", "soap", "mousse", "foot cream", "cleanser"],
      "Health & Beauty - Self Tanning": ["tanning", "tan"],
      "Health & Beauty - Haircare": ["hair", "scalp", "conditioner", "shampoo"],
      "Health & Beauty - Perfume": ["perfume", "feminine"],
      "Health & Beauty - Cologne": ["cologne", "hugo boss", "masculine"],
      "Health & Beauty - Makeup": ["eyeshadow", "concealer", "makeup", "lip"],
      "Clothing & Accessories - Men": ["men", "men’s"],
      "Clothing & Accessories - Women": ["ladies", "women", "lingerie"],
      "Women’s Jewellery": ["charm", "necklace", "bracelet", "pendant", "studs", "earrings"],
      "Children & Baby": ["children", "child", "baby", "babies"],
      "Cooking & Kitchen": ["air fryer", "coffee", "utensil", "knife", "oven", "blender", "kitchen"],
      "Vintage Wines": ["wine", "vintage", "port", "shiraz"]
    };

    document.getElementById("csvFile").addEventListener("change", function (event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const csv = e.target.result;
        allProducts = parseCSV(csv).filter(p => p.merchant_image_url && p.aw_deep_link);
        populateFilters();
        applyFilters();
      };
      reader.readAsText(file);
    });

    document.getElementById("searchInput").addEventListener("input", applyFilters);
    document.getElementById("merchantFilter").addEventListener("change", applyFilters);
    document.getElementById("categoryFilter").addEventListener("change", applyFilters);

    function parseCSV(data) {
      const lines = data.split("\n").filter(Boolean);
      const headers = lines[0].split(",");
      return lines.slice(1).map(line => {
        const values = line.split(",");
        const obj = {};
        headers.forEach((header, i) => {
          obj[header.trim()] = values[i]?.trim();
        });
        return obj;
      });
    }

   function populateFilters() {
  const merchantFilter = document.getElementById("merchantFilter");
  const categoryFilter = document.getElementById("categoryFilter");

  merchantFilter.innerHTML = `<option value="">Filter by Merchant</option>`;
  categoryFilter.innerHTML = `<option value="">Filter by Category</option>`;

  // ✅ Merchants
  approvedMerchants.forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    merchantFilter.appendChild(opt);
  });

  // ✅ Group categories by parent (e.g., "Special Occasions")
  const groupedCategories = {};

  Object.keys(categoryKeywords).forEach(fullCat => {
    const [group, subcat] = fullCat.split(" - ");
    if (!groupedCategories[group]) groupedCategories[group] = [];
    groupedCategories[group].push({ label: subcat, value: fullCat });
  });

  // ✅ Inject bold (All) options only, and subcategories beneath
  Object.entries(groupedCategories).forEach(([group, subcats]) => {
    // ⬇️ Main Category (All) – bolded
    const mainOpt = document.createElement("option");
    mainOpt.value = group;
    mainOpt.innerHTML = `<strong>${group} (All)</strong>`;
    categoryFilter.appendChild(mainOpt);

    // ⬇️ Subcategories
    subcats.forEach(subcat => {
      const opt = document.createElement("option");
      opt.value = subcat.value;
      opt.textContent = subcat.label;
      categoryFilter.appendChild(opt);
    });
  });
}

    function applyFilters() {
      const keyword = document.getElementById("searchInput").value.toLowerCase();
      const selectedMerchant = document.getElementById("merchantFilter").value;
      const selectedCategory = document.getElementById("categoryFilter").value;

      let effectiveKeywords = [];

if (categoryKeywords[selectedCategory]) {
  // Sub-category selected
  effectiveKeywords = categoryKeywords[selectedCategory];
} else if (selectedCategory) {
  // Parent category selected — gather all subcategory keywords under it
  const groupMatch = Object.entries(categoryKeywords)
    .filter(([key]) => key.startsWith(selectedCategory + " -"))
    .flatMap(([, keywords]) => keywords);

  effectiveKeywords = groupMatch;
}

      filteredProducts = allProducts.filter(p => {
        const productName = p.product_name?.toLowerCase() || "";
        const isMerchantMatch = !selectedMerchant || p.merchant_name === selectedMerchant;

        let isCategoryMatch = true;
if (selectedCategory) {
  isCategoryMatch = effectiveKeywords.some(term => productName.includes(term));
}

        const isKeywordMatch = !keyword || productName.includes(keyword);

        return isMerchantMatch && isCategoryMatch && isKeywordMatch;
      });

      currentPage = 1;
      displayProducts();
      renderPagination();
    }

    function displayProducts() {
      const container = document.getElementById("productContainer");
      const spinner = document.getElementById("spinner");

      spinner.style.display = "block";
      container.classList.remove("fade-in");
      container.classList.add("fade-out");

      setTimeout(() => {
        container.innerHTML = "";
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageProducts = filteredProducts.slice(start, end);

        pageProducts.forEach(product => {
          const name = product.product_name?.replace(/"/g, '').trim();
          const image = product.merchant_image_url?.trim();
          const link = product.aw_deep_link?.trim();

          if (!image || !link || !link.startsWith("http")) return;

          const div = document.createElement("div");
          div.classList.add("product");

          div.innerHTML = `
            <a href="${link}" target="_blank" class="image-link">
              <img src="${image}" alt="${name}" onerror="this.closest('.product').remove();" />
            </a>
            <a href="${link}" target="_blank" class="title-link"><h3>${name}</h3></a>
            <a href="${link}" target="_blank">View Product</a>
          `;

          container.appendChild(div);
        });

        spinner.style.display = "none";
        container.classList.remove("fade-out");
        container.classList.add("fade-in");
      }, 200);
    }

    function renderPagination() {
      const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
      const pagination = document.getElementById("paginationControls");
      pagination.innerHTML = "";

      const addPageButton = (pageNum) => {
        const btn = document.createElement("button");
        btn.textContent = pageNum;
        if (pageNum === currentPage) btn.classList.add("active");
        btn.onclick = () => {
          currentPage = pageNum;
          displayProducts();
          renderPagination();
        };
        pagination.appendChild(btn);
      };

      const prevBtn = document.createElement("button");
      prevBtn.textContent = "Previous";
      prevBtn.disabled = currentPage === 1;
      prevBtn.onclick = () => {
        currentPage--;
        displayProducts();
        renderPagination();
      };
      pagination.appendChild(prevBtn);

      addPageButton(1);

      if (currentPage > 6) {
        const ellipsis = document.createElement("span");
        ellipsis.textContent = "...";
        ellipsis.className = "ellipsis";
        pagination.appendChild(ellipsis);
      }

      const start = Math.max(2, currentPage - 2);
      const end = Math.min(totalPages - 1, currentPage + 2);

      for (let i = start; i <= end; i++) {
        if (i !== 1 && i !== totalPages) {
          addPageButton(i);
        }
      }

      if (end < totalPages - 1) {
        const ellipsis = document.createElement("span");
        ellipsis.textContent = "...";
        ellipsis.className = "ellipsis";
        pagination.appendChild(ellipsis);
      }

      if (totalPages > 1) addPageButton(totalPages);

      const nextBtn = document.createElement("button");
      nextBtn.textContent = "Next";
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.onclick = () => {
        currentPage++;
        displayProducts();
        renderPagination();
      };
      pagination.appendChild(nextBtn);
    }
  </script>
</body>
</html>
