<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Your Gift List | PresentPal</title>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon.png">

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f9f9f9;
      color: #333;
      text-align: center;
    }
    h1 {
      margin-bottom: 20px;
    }
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      align-items: center;
      margin-bottom: 20px;
    }
    .filter-bar input,
    .filter-bar select {
      padding: 10px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 220px;
      max-width: 90%;
    }
    .product {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin: 10px;
      padding: 15px;
      width: 250px;
      height: 360px;
      display: inline-flex;
      flex-direction: column;
      justify-content: space-between;
      text-align: center;
      box-sizing: border-box;
    }
    .product img {
      width: 100%;
      height: 180px;
      object-fit: contain;
      border: none;
    }
    .product h3 {
      font-size: 14px;
      margin: 10px 0 0;
      line-height: 1.2em;
      max-height: 2.4em;
      overflow: hidden;
    }
    .product a {
      display: inline-block;
      margin-top: 10px;
      padding: 10px 16px;
      background-color: #007bff;
      color: white;
      border-radius: 6px;
      font-weight: bold;
      text-decoration: none;
      transition: background-color 0.3s ease;
    }
    .product a:hover {
      background-color: #0056b3;
    }
    .pagination {
      margin-top: 30px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    .pagination button {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .pagination button:hover {
      background-color: #0056b3;
    }
    .pagination button.active {
      background: #0056b3;
      font-weight: bold;
    }
    .pagination button:disabled {
      background: #ccc;
      cursor: default;
    }
    #productContainer.fade-out {
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    #productContainer.fade-in {
      opacity: 1;
      transition: opacity 0.3s ease;
    }
  </style>
</head>
<body>
  <h1>Find the Perfect Gift</h1>

  <div class="filter-bar">
    <input type="text" id="searchInput" placeholder="Search products..." />
    <select id="merchantFilter">
      <option value="">Filter by Merchant</option>
    </select>
    <select id="categoryFilter">
      <option value="">Filter by Category</option>
    </select>
  </div>

  <div id="spinner" style="display: none; font-weight: bold; margin: 20px;">Loading products...</div>
  <div id="productContainer"></div>
  <div class="pagination" id="paginationControls"></div>

  <script>
    let allProducts = [];
    let filteredProducts = [];
    let currentPage = 1;
    const itemsPerPage = 24;

    async function fetchProducts(page = 1) {
      const url = `https://evening-basin-64817-f38e98d8c5e2.herokuapp.com/products.json?page=${page}&limit=${itemsPerPage}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        allProducts = data.filter(p => p.image && p.link);
        populateFilters();
        applyFilters();
      } catch (err) {
        console.error("❌ Failed to fetch products:", err);
        alert("Failed to load product data.");
      }
    }

    function populateFilters() {
  const merchantFilter = document.getElementById("merchantFilter");
  const categoryFilter = document.getElementById("categoryFilter");

  const merchantSet = new Set();
  const categoryMap = {};

  allProducts.forEach(product => {
    if (product.merchant) {
      merchantSet.add(product.merchant);
    }

    const cat = product.category?.trim();
    if (cat) {
      categoryMap[cat] = (categoryMap[cat] || 0) + 1;
    }
  });

  // ✅ Only show merchants that actually appear
  Array.from(merchantSet).sort().forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    merchantFilter.appendChild(opt);
  });

  // ✅ Only show categories that appear ≥ 3 times
  Object.entries(categoryMap)
    .filter(([_, count]) => count >= 3)
    .sort((a, b) => a[0].localeCompare(b[0]))
    .forEach(([cat]) => {
      const opt = document.createElement("option");
      opt.value = cat;
      opt.textContent = cat;
      categoryFilter.appendChild(opt);
    });
}
    
    function applyFilters() {
      const search = document.getElementById("searchInput").value.toLowerCase();
      const merchant = document.getElementById("merchantFilter").value;
      const category = document.getElementById("categoryFilter").value;

      filteredProducts = allProducts.filter(p => {
        const name = (p.name || "").toLowerCase();
        const matchSearch = !search || name.includes(search);
        const matchMerchant = !merchant || p.merchant === merchant;
        const matchCategory = !category || p.category === category;
        return matchSearch && matchMerchant && matchCategory;
      });

      currentPage = 1;
      renderProducts();
      renderPagination();
    }

    function renderProducts() {
      const container = document.getElementById("productContainer");
      const spinner = document.getElementById("spinner");

      spinner.style.display = "block";
      container.classList.remove("fade-in");
      container.classList.add("fade-out");

      setTimeout(() => {
        container.innerHTML = "";
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageProducts = filteredProducts.slice(start, end);

        pageProducts.forEach(p => {
          const div = document.createElement("div");
          div.className = "product";
          div.innerHTML = `
            <a href="${p.link}" target="_blank" class="image-link">
              <img src="${p.image}" alt="${p.name}" onerror="this.closest('.product').remove();" />
            </a>
            <a href="${p.link}" target="_blank" class="title-link"><h3>${p.name}</h3></a>
            <a href="${p.link}" target="_blank">View Product</a>
          `;
          container.appendChild(div);
        });

        spinner.style.display = "none";
        container.classList.remove("fade-out");
        container.classList.add("fade-in");
      }, 200);
    }

    function renderPagination() {
      const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
      const pagination = document.getElementById("paginationControls");
      pagination.innerHTML = "";

      const addBtn = (num) => {
        const btn = document.createElement("button");
        btn.textContent = num;
        if (num === currentPage) btn.classList.add("active");
        btn.onclick = () => {
          currentPage = num;
          renderProducts();
          renderPagination();
        };
        pagination.appendChild(btn);
      };

      const prev = document.createElement("button");
      prev.textContent = "Previous";
      prev.disabled = currentPage === 1;
      prev.onclick = () => {
        currentPage--;
        renderProducts();
        renderPagination();
      };
      pagination.appendChild(prev);

      for (let i = 1; i <= totalPages; i++) {
        if (i <= 2 || i > totalPages - 2 || Math.abs(currentPage - i) <= 2) {
          addBtn(i);
        } else if (
          (i === 3 && currentPage > 5) ||
          (i === totalPages - 2 && currentPage < totalPages - 4)
        ) {
          const dots = document.createElement("span");
          dots.textContent = "...";
          pagination.appendChild(dots);
        }
      }

      const next = document.createElement("button");
      next.textContent = "Next";
      next.disabled = currentPage === totalPages;
      next.onclick = () => {
        currentPage++;
        renderProducts();
        renderPagination();
      };
      pagination.appendChild(next);
    }

    document.getElementById("searchInput").addEventListener("input", applyFilters);
    document.getElementById("merchantFilter").addEventListener("change", applyFilters);
    document.getElementById("categoryFilter").addEventListener("change", applyFilters);

    fetchProducts();
  </script>
</body>
</html>
