<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gift Catalogue</title>

   <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon.png">
  
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f9f9f9;
      color: #333;
      text-align: center;
    }

    h1 {
      margin-bottom: 20px;
    }

    /* General Styling for Dropdowns */
select {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background-color: white;
  border: 1px solid #ccc;
  padding: 10px 14px;
  border-radius: 6px;
  font-size: 14px;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  background-image: url("data:image/svg+xml;utf8,<svg fill='gray' height='20' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 16px 16px;
  padding-right: 36px;
}

/* Hover & Focus */
select:hover {
  border-color: #007bff;
}

       /* Main category options (bold) */
select option.main-category {
  font-weight: bold;
  background-color: #f0f0f0;
  color: #333;
}

/* Subcategory options (indented) */
select option.sub-category {
  padding-left: 20px;
}

select:focus {
  outline: none;
  border-color: #007bff;
  box-shadow: 0 0 0 2px rgba(0,123,255,0.2);
}

    input[type="file"],
    #searchBar,
    select {
      margin: 10px;
      padding: 10px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    #filters {
      margin-bottom: 20px;
    }
    
    .filter-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  align-items: center;
  margin-bottom: 20px;
}

.filter-bar input,
.filter-bar select {
  padding: 10px;
  font-size: 14px;
  border-radius: 6px;
  border: 1px solid #ccc;
  width: 220px;
  max-width: 90%;
}


    .product {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin: 10px;
      padding: 15px;
      width: 250px;
      height: 360px;
      display: inline-flex;
      flex-direction: column;
      justify-content: space-between;
      text-align: center;
      box-sizing: border-box;
    }

    .product img {
      width: 100%;
      height: 180px;
      object-fit: contain;
      border: none;
    }

    .product h3 {
      font-size: 14px;
      margin: 10px 0 0;
      line-height: 1.2em;
      max-height: 2.4em;
      overflow: hidden;
    }

    .product a {
      display: inline-block;
      margin-top: 10px;
      padding: 10px 16px;
      background-color: #007bff;
      color: white;
      border-radius: 6px;
      font-weight: bold;
      text-decoration: none;
      transition: background-color 0.3s ease;
    }

    .product a:hover {
      background-color: #0056b3;
    }

    .product a.image-link,
    .product a.title-link {
      background: none;
      padding: 0;
      margin: 0;
      text-decoration: none;
      color: inherit;
    }

    .product a.image-link:hover,
    .product a.title-link:hover {
      background: none;
      color: #007bff;
    }

    .pagination {
      margin-top: 30px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
    }

    .pagination button {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .pagination button:hover {
      background-color: #0056b3;
    }

    .pagination button.active {
      background: #0056b3;
      font-weight: bold;
    }

    .pagination button:disabled {
      background: #ccc;
      cursor: default;
    }

    .pagination .ellipsis {
      padding: 8px 10px;
      color: #555;
    }

    #productContainer.fade-out {
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    #productContainer.fade-in {
      opacity: 1;
      transition: opacity 0.3s ease;
    }

  </style>
</head>
<body>
  <h1>Gift Catalogue</h1>
  <input type="file" id="csvFile" accept=".csv" />

  <div class="filter-bar">
    <input type="text" id="searchInput" placeholder="Search products..." />
    <select id="merchantFilter">
      <option value="">Filter by Merchant</option>
    </select>
    <select id="categoryFilter">
      <option value="">Filter by Category</option>
    </select>
  </div>

  <div id="spinner" style="display: none; font-weight: bold; margin: 20px;">Loading products...</div>
  <div id="productContainer"></div>
  <div class="pagination" id="paginationControls"></div>

  <script>
    let allProducts = [];
    let filteredProducts = [];
    let currentPage = 1;
    const itemsPerPage = 24;

    const approvedMerchants = [
      "Theatre Tickets Direct", "Wowow Toys", "Plusshop UK", "Tisserand Aromatherapy", "Game Over",
      "Kaliese", "Uud fragrances", "Tooled Up", "Forever Lily", "Little Women Lingerie",
      "Vistaexpert UK", "My Kind of Cruise", "Sport and Leisure UK", "Webbs Motorcycles",
      "Mafett UK", "Edx Education UK Limited", "Spoiled Brat", "Pott'd UK", "Kokoso Baby",
      "We are Nutrified", "Polaris Bikewear", "T.LUXY", "Cronjager", "Furniture Life",
      "Fishcave Aquatics", "Love Tech Hate Waste", "Vintage Wine Gifts", "OFFSCENT",
      "Simply LED", "MyBeauty.Boutique"
    ];

    const categoryKeywords = {
  "Special Occasions - Mothers Day": ["mother's day", "mum gift", "gift for mum", "mothers day"],
  "Special Occasions - Mummy to be": ["mummy to be", "expecting mum", "baby shower"],
  "Special Occasions - Valentine’s gifts": ["valentine's gift", "valentines", "romantic gift"],
  "Special Occasions - Weddings": ["wedding gift", "bride to be", "bridesmaids", "bridal", "engagement gift"],
  "Special Occasions - Birthday": ["birthday gift", "bday gift", "birthday present"],
  "Special Occasions - Halloween": ["halloween", "spooky", "trick or treat"],
  "Special Occasions - Easter": ["easter", "easter egg", "easter bunny"],
  "Special Occasions - Christmas": ["christmas gift", "xmas", "santa", "stocking filler", "holiday gift"],

  "Gifting - Candles": ["scented candle", "candles", "aroma candle", "candle set"],
  "Gifting - Gift Bags": ["gift bag", "present bag"],
  "Gifting - Cards": ["greeting card", "birthday card", "valentine card"],

  "Health & Beauty - Skincare": ["moisturiser", "face wash", "cleanser", "serum", "face cream", "skincare", "eye cream", "hydrating cream"],
  "Health & Beauty - Self Tanning": ["self tan", "tanning mousse", "bronzing lotion", "tanning spray"],
  "Health & Beauty - Haircare": ["shampoo", "conditioner", "hair mask", "scalp treatment", "hair oil"],
  "Health & Beauty - Perfume": ["women's perfume", "eau de parfum", "fragrance for her", "floral perfume"],
  "Health & Beauty - Cologne": ["men's cologne", "aftershave", "eau de toilette", "fragrance for him"],
  "Health & Beauty - Makeup": ["foundation", "lipstick", "mascara", "eyeshadow", "blush", "concealer", "makeup palette"],

  "Clothing & Accessories - Men": ["men's t-shirt", "men's hoodie", "menswear", "men's jacket"],
  "Clothing & Accessories - Women": ["women's dress", "women's clothing", "ladies top", "lingerie", "womenswear"],
  "Women’s Jewellery": ["necklace", "bracelet", "stud earrings", "charm", "pendant", "jewellery set"],
  "Children & Baby": ["baby clothes", "baby toy", "kids shoes", "children's book", "newborn gift"],

  "Cooking & Kitchen": [
    "kitchen appliance", "air fryer", "blender", "slow cooker", "toaster", "coffee machine",
    "cooking pan", "baking tray", "utensil set", "knife block", "oven gloves", "cooking pot", "cookware"
  ],

  "Vintage Wines": ["vintage wine", "aged wine", "red wine gift", "shiraz wine", "port wine", "wine set"]
};

    document.getElementById("csvFile").addEventListener("change", function (event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const csv = e.target.result;
        allProducts = parseCSV(csv).filter(p => p.merchant_image_url && p.aw_deep_link);
        populateFilters();
        applyFilters();
      };
      reader.readAsText(file);
    });

    document.getElementById("searchInput").addEventListener("input", applyFilters);
    document.getElementById("merchantFilter").addEventListener("change", applyFilters);
    document.getElementById("categoryFilter").addEventListener("change", applyFilters);

    function parseCSV(data) {
      const lines = data.split("\n").filter(Boolean);
      const headers = lines[0].split(",");
      return lines.slice(1).map(line => {
        const values = line.split(",");
        const obj = {};
        headers.forEach((header, i) => {
          obj[header.trim()] = values[i]?.trim();
        });
        return obj;
      });
    }

   function populateFilters() {
  const merchantFilter = document.getElementById("merchantFilter");
  const categoryFilter = document.getElementById("categoryFilter");

  // Merchants
  approvedMerchants.forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    merchantFilter.appendChild(opt);
  });

  // Categories with hierarchy
  const categoryGroups = {};
  Object.keys(categoryKeywords).forEach(cat => {
    const [main, sub] = cat.split(" - ");
    if (!categoryGroups[main]) categoryGroups[main] = [];
    categoryGroups[main].push({ label: sub || main, value: cat });
  });

  Object.entries(categoryGroups).forEach(([main, subs]) => {
    // Main category "All" option
    const mainOpt = document.createElement("option");
    mainOpt.value = main; // Match main title for filtering
    mainOpt.textContent = `${main} (All)`;
    mainOpt.className = "main-category";
    categoryFilter.appendChild(mainOpt);

    // Subcategories
    subs.forEach(({ label, value }) => {
      const subOpt = document.createElement("option");
      subOpt.value = value;
      subOpt.textContent = label;
      subOpt.className = "sub-category";
      categoryFilter.appendChild(subOpt);
    });
  });
}

    function cleanText(str) {
  const noiseWords = [
    "with", "for", "and", "gift", "set", "of", "in", "on", "the", "a", "an", "to", "includes", "by"
  ];
  return str
    .toLowerCase()
    .replace(/[^\w\s]/g, '') // remove punctuation
    .split(/\s+/)
    .filter(word => !noiseWords.includes(word))
    .join(' ');
}

    function applyFilters() {
  const keyword = document.getElementById("searchInput").value.toLowerCase();
  const selectedMerchant = document.getElementById("merchantFilter").value;
  const selectedCategory = document.getElementById("categoryFilter").value;

  let effectiveKeywords = [];
  const negativeKeywords = {
    "Special Occasions - Halloween": ["cruise", "holiday", "soiree", "trip"],
    "Cooking & Kitchen": ["foundation", "makeup", "beauty", "lipstick"],
  };

  if (categoryKeywords[selectedCategory]) {
    effectiveKeywords = categoryKeywords[selectedCategory];
  } else if (selectedCategory) {
    const groupMatch = Object.entries(categoryKeywords)
      .filter(([key]) => key.startsWith(selectedCategory + " -"))
      .flatMap(([, keywords]) => keywords);
    effectiveKeywords = groupMatch;
  }

  // ✅ Step 5: Scoring-based filtering
  filteredProducts = allProducts.filter(p => {
    const cleanedName = (p.product_name || '').toLowerCase();
    const cleanedCategory = (p.merchant_category || '').toLowerCase();
    const custom1 = (p.custom_1 || '').toLowerCase();
    const custom2 = (p.custom_2 || '').toLowerCase();

    const searchableText = `${cleanedName} ${cleanedCategory} ${custom1} ${custom2}`;
    const isMerchantMatch = !selectedMerchant || p.merchant_name === selectedMerchant;

    // 🔢 Score keyword matches
    let keywordScore = 0;
    effectiveKeywords.forEach(term => {
      const regex = new RegExp(`\\b${term}\\b`, 'i');
      if (regex.test(cleanedCategory)) keywordScore += 2;      // stronger match in category
      else if (regex.test(cleanedName)) keywordScore += 1;     // lighter match in title
      else if (regex.test(custom1) || regex.test(custom2)) keywordScore += 1;
    });

    let isCategoryMatch = keywordScore > 0;

    // ⛔ Exclude false positives
    if (isCategoryMatch && negativeKeywords[selectedCategory]) {
      const negativeTerms = negativeKeywords[selectedCategory];
      isCategoryMatch = !negativeTerms.some(term =>
        searchableText.includes(term)
      );
    }

    const isKeywordMatch = !keyword || searchableText.includes(keyword);

    return isMerchantMatch && isCategoryMatch && isKeywordMatch;
  });

  console.log(`Filtered ${filteredProducts.length} products for category: ${selectedCategory}`);

  currentPage = 1;
  displayProducts();
  renderPagination();
}
    
    function displayProducts() {
      const container = document.getElementById("productContainer");
      const spinner = document.getElementById("spinner");

      spinner.style.display = "block";
      container.classList.remove("fade-in");
      container.classList.add("fade-out");

      setTimeout(() => {
        container.innerHTML = "";
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageProducts = filteredProducts.slice(start, end);

        pageProducts.forEach(product => {
          const name = product.product_name?.replace(/"/g, '').trim();
          const image = product.merchant_image_url?.trim();
          const link = product.aw_deep_link?.trim();

          if (!image || !link || !link.startsWith("http")) return;

          const div = document.createElement("div");
          div.classList.add("product");

          div.innerHTML = `
            <a href="${link}" target="_blank" class="image-link">
              <img src="${image}" alt="${name}" onerror="this.style.display='none';" />
            </a>
            <a href="${link}" target="_blank" class="title-link"><h3>${name}</h3></a>
            <a href="${link}" target="_blank">View Product</a>
          `;

          container.appendChild(div);
        });

        spinner.style.display = "none";
        container.classList.remove("fade-out");
        container.classList.add("fade-in");
      }, 200);
    }

    function renderPagination() {
      const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
      const pagination = document.getElementById("paginationControls");
      pagination.innerHTML = "";

      const addPageButton = (pageNum) => {
        const btn = document.createElement("button");
        btn.textContent = pageNum;
        if (pageNum === currentPage) btn.classList.add("active");
        btn.onclick = () => {
          currentPage = pageNum;
          displayProducts();
          renderPagination();
        };
        pagination.appendChild(btn);
      };

      const prevBtn = document.createElement("button");
      prevBtn.textContent = "Previous";
      prevBtn.disabled = currentPage === 1;
      prevBtn.onclick = () => {
        currentPage--;
        displayProducts();
        renderPagination();
      };
      pagination.appendChild(prevBtn);

      addPageButton(1);

      if (currentPage > 6) {
        const ellipsis = document.createElement("span");
        ellipsis.textContent = "...";
        ellipsis.className = "ellipsis";
        pagination.appendChild(ellipsis);
      }

      const start = Math.max(2, currentPage - 2);
      const end = Math.min(totalPages - 1, currentPage + 2);

      for (let i = start; i <= end; i++) {
        if (i !== 1 && i !== totalPages) {
          addPageButton(i);
        }
      }

      if (end < totalPages - 1) {
        const ellipsis = document.createElement("span");
        ellipsis.textContent = "...";
        ellipsis.className = "ellipsis";
        pagination.appendChild(ellipsis);
      }

      if (totalPages > 1) addPageButton(totalPages);

      const nextBtn = document.createElement("button");
      nextBtn.textContent = "Next";
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.onclick = () => {
        currentPage++;
        displayProducts();
        renderPagination();
      };
      pagination.appendChild(nextBtn);
    }
  </script>
</body>
</html>
