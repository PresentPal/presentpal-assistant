<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Your Gift List | PresentPal</title>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon.png">

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f9f9f9;
      color: #333;
      text-align: center;
    }
    h1 {
      margin-bottom: 20px;
    }
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      align-items: center;
      margin-bottom: 20px;
    }
    .filter-bar input,
    .filter-bar select {
      padding: 10px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 220px;
      max-width: 90%;
    }
    .product {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin: 10px;
      padding: 15px;
      width: 250px;
      height: 360px;
      display: inline-flex;
      flex-direction: column;
      justify-content: space-between;
      text-align: center;
      box-sizing: border-box;
    }
    .product img {
      width: 100%;
      height: 180px;
      object-fit: contain;
      border: none;
    }
    .product h3 {
      font-size: 14px;
      margin: 10px 0 0;
      line-height: 1.2em;
      max-height: 2.4em;
      overflow: hidden;
    }
    .product a {
      display: inline-block;
      margin-top: 10px;
      padding: 10px 16px;
      background-color: #007bff;
      color: white;
      border-radius: 6px;
      font-weight: bold;
      text-decoration: none;
      transition: background-color 0.3s ease;
    }
    .product a:hover {
      background-color: #0056b3;
    }
    .pagination {
      margin-top: 30px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    .pagination button {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .pagination button:hover {
      background-color: #0056b3;
    }
    .pagination button.active {
      background: #0056b3;
      font-weight: bold;
    }
    .pagination button:disabled {
      background: #ccc;
      cursor: default;
    }
    #productContainer.fade-out {
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    #productContainer.fade-in {
      opacity: 1;
      transition: opacity 0.3s ease;
    }
  </style>
</head>
<body>
  <h1>Find the Perfect Gift</h1>

  <div class="filter-bar">
    <input type="text" id="searchInput" placeholder="Search products..." />
    <select id="categoryFilter">
      <option value="">Filter by Category</option>
    </select>
  </div>
  
<div style="margin-bottom: 20px;">
  <button id="downloadBrokenBtn" style="padding: 10px 16px; background-color: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">
    ðŸ“¦ Download Broken Products
  </button>
</div>

  <button id="downloadUnmapped" style="margin: 30px; padding: 10px;">ðŸ“¥ Download Unmapped Categories</button>

  <div id="productContainer"></div>
  <div class="pagination" id="paginationControls"></div>

<script>
let allProducts = [];
let filteredProducts = [];
let currentPage = 1;
const itemsPerPage = 24;

const categoryKeywords = {
  "ðŸŽ‰ Special Occasions": {
    "Mothers Day": ["Mothers Day"],
    "Mummy to be": ["Mummy to be"],
    "Valentineâ€™s": ["Valentineâ€™s Day"],
    "Weddings": ["Wedding"],
    "Birthday": ["Birthday"],
    "Halloween": ["Halloween"],
    "Easter": ["Easter"],
    "Christmas": ["Christmas"]
  },
  "ðŸŽ Gifting": {
    "Gifts For Him": [
      "Men > GaveÃ¦sker",
      "Men > Personal Care > Fragrances > Eau de parfum > Gift sets >", "Alcoholic Drinks"
    ],
    "Gifts For Her": ["Gifts & Kits > Body > All Products > Natureâ€™s Spa Bath and Body Collection", "Alcoholic Drinks"],
    "Gift Bags": ["Gifts & Kits > All Products > Gift Bags"],
    "Decorations": ["Gifts, Gadgets & Toys > Gifts > Decorations"],
    "Collectables": ["Gifts, Gadgets & Toys > Gifts > Collectibles"]
  },
  "ðŸ’„ Health & Beauty": {
    "Womensâ€™ Personal Care": [],
    "Bath & Body": ["Bath & Body", "Tea Tree & Aloe > Body"],
    "Makeup": ["Makeup", "Make-up"],
    "Hair Care": [
      "Men > Women > Personal care > Personal care > Personal Care > Hair care & styling", "Beauty, Hair care", "Women > Personal care > Hair care & styling >"
    ],
    "Nail Care": ["Nail Care"],
    "Perfume": ["Beauty, Perfumes and fragrances"],
    "Shaving & Hair Removal": ["Beauty, Shaving and hair removal"],
    "Skin Care": [
      "Skin Care",
      "Skincare",
      "Men > Women > Personal care > Personal Care > Face & skin care", "Beauty, Skin care", "Women > Personal care > Face & skin care > Face care > Face moisturisers & serum >", "Women > Personal care > Face & skin care > Face masks >"
    ],
    "Mensâ€™ Personal Care": [],
    "Shaving & Grooming": [
      "Shaving & Grooming",
      "Men > Personal Care > Shaving & hair-cutting >"
    ],
    "Body Wash & Shower Gel": ["Men > Personal Care > Hygiene"],
    "Hair Care (Men)": [
      "Men > Personal Care > Hair care",
      "Men > Women > Personal care > Personal care > Personal Care > Hair care & styling"
    ],
    "Mens Fragrances": ["Men > Personal Care > Fragrances"],
    "Skin Care (Men)": [
      "Men > Personal Care > Skin care",
      "Men > Women > Personal care > Personal Care > Face & skin care"
    ],
    "Intimate": ["Men > Personal Care > Intimate"],
    "Oral Care": ["Oral Care", "Men > Personal Care > Mouth hygiene"],
    "Hygiene": ["Men > Women > Personal care", "Personal Care > Hygiene"],
    "Manicure & Pedicure": ["Manicure & pedicure >"],
    "Massage": ["Massage >"]
  },
  "ðŸ‘• Clothing & Accessories": {
    "Mens": [],
    "Wristwatches": [
      "Men > Accessories > Analog Watches > Wristwatches",
      "Men > Accessories > Sports Watches",
      "Men > Accessories > Wristwatches",
      "Men > Analog watches"
    ],
    "Shoes": ["Shoes > Men >"],
    "Sunglasses": ["Men > Accessories > Sunglasses >"],
    "Accessories": ["Menâ€™s Accessories"],
    "Deals": [
      "Men > Accessories > Deals",
      "Men > Personal Care > Deals"
    ],
    "Unisex": [],
    "Unisex Sunglasses": ["Men > Women > Accessories > Accessories > Sunglasses > Sunglasses >"],
    "Unisex Wristwatches": [
      "Men > Women > Accessories > Accessories > Wristwatches > Wristwatches > Accessories > Accessories >",
      "Men > Women > Accessories > Accessories > Wristwatches > Wristwatches > Digital watches",
      "Men > Women > Accessories > Analog Watches",
      "Men > Women > Accessories > Sport watches",
      "Men > Women > Accessories > Training & fitness",
      "Men > Women > Accessories > Wristwatches",
      "Men > Women > Electronics & accessories"
    ],
      "Unisex Shoes": ["Shoes > Men > Women >"],
    "Womens": [],
    "Shoes": ["Shoes > Women >"],
    "Boys": [],
    "Shoes": ["Shoes > Boys >"],
    "Girls": [],
    "Shoes": ["Shoes > Girls >"],
    "Children Wristwatches": ["Men > Women > Children > Accessories > Baby & children products"]
  },
  "ðŸ’ Jewellery": {},
  
  "ðŸ§’ Children & Baby": {
    "Games, Puzzles & Learning": ["Games, Puzzles & Learning", "Children > Baby & children products > Activities & play time >"],
    "Entertainment": ["Kids Audio Players"],
    "Bathroom & Care": ["Children > Baby & children products > Bathroom & care", "Children > Baby & children products > Dental care", "Children > Baby & children products > Hygiene", "Baby Bathtime"]
  },
  "ðŸ½ Cooking & Kitchen": {
    "Tableware": ["Tableware", "Kitchen > Tableware & cutlery trays"],
    "Coffee & Tea": ["Home > Coffee & tea"],
    "Grill & Accessories": ["Kitchen > Grill & accessories"],
    "Knives & Accessories": ["Kitchen > Knives & accessories"],
    "Pans & Skillets": ["Kitchen > Pans & skillets"],
    "Appliances": ["Kitchen > Kitchen appliances", "Kitchen > Kitchen scales"],
    "Wine & Cocktails": ["Kitchen > Wine & cocktail"],
    "Deals": ["Kitchen > Deals"]
  },
  "ðŸ· Vintage Wines": {},
  "ðŸŽ® Games": {
    "Consoles": ["Consoles"],
    "PlayStation": ["Playstation"],
    "Xbox": ["Xbox"],
    "PC Gaming": ["PC Gaming"],
    "Nintendo": ["Nintendo"],
    "Portable Gaming": ["Portable Gaming"],
    "Retro Gaming": ["Retro Gaming"],
    "Gaming Accessories": ["Console Accessories"],
    "Board & Desktop Games": ["board & desktop games"],
    "Multi-Game Tables": ["Air Hockey Tables", "Multi-Game Tables", "Pool Tables", "Table Football", "Table Tennis"]
  },
  "ðŸ¾ Pets": {
    "Pet Accessories": ["Household > Deals > Pet accessories", "Home > Household > Pet accessories >"]
  },
  "ðŸ’» Tech": {
    "Mobile Phones": ["Mobile Phones > Android Phones", "Mobile Phones > Windows Phones", "Mobile Phones > iPhones"],
    "Phone & Tablet Accessories": ["Electronics & accessories > Accessories for phones and tablets"],
    "Home Audio & Speakers": ["Home Audio & Speakers"],
    "Media Players": ["Media Players"],
    "Televisions & Accessories": ["Televisions & Accessories", "3D TV"],
    "Video Components": ["Video Components"],
    "Cameras & Camcorders": ["Cameras & Camcorders"],
    "Security & Automation": ["Security & Automation"],
    "Electronic Accessories": [
      "Computer Spare Parts",
      "Electronics & accessories > accessories for phones and tablets",
      "Household > Cables",
      "Household > Deals",
      "Household > Home Security",
      "Microphones & Headphones"
    ],
    "Laptops": ["Laptops"]
  },
  "ðŸ  Household": {
    "Cleaning Supplies": ["Cleaning Supplies", "Household > Cleaning"],
    "Laundry": ["Laundry", "Household > Clean, iron & dry"],
    "Essential Oils": ["Essential Oils > All Products > Blending", "Gifts & Kits > Essential Oils > All Products"],
    "Home Security": ["Household > Home Security", "Home Security > Alarms"],
    "Car & Bike": ["Household > Car & bike"],
    "Toilet & Bathroom": ["Household > toilet and bathroom"],
    "Vacuum Cleaners": ["Household > Vacuum cleaners"]
  },
  "ðŸš  DIY & Renovations": {
    "Adhesives, Sealants & Fillers": ["Adhesives, Sealants & Fillers"],
    "Air Tools & Compressors": ["Air Tools & Compressors"],
    "Hardware": ["DIY And Hardware", "Household & Hardware"],
    "Paints, Tools & Wall Treatments": ["Paints, tools and wall treatments", "Paints & Varnishes >"],
    "Decorating & Tiling Tools": ["Decorating & Tiling Tools"],
    "Construction Supplies": ["Construction Supplies"],
    "Electrical Supplies": ["Electrical Supplies"],
    "Hand Tools": ["Hand Tools", "Power Tools >"],
    "Ladders & Sack Trucks": ["Ladders & Sack Trucks"],
    "Lighting & Torches": ["Lighting & Torches"],
    "Machinery": ["Machinery >"],
    "Measuring Tools": ["Measuring Tools >"],
    "Plumbing Tools": ["Plumbing Tools >"]
  },
  "ðŸªº Interior Decorating": {
    "Furniture": ["Furniture > Tables"],
    "Home Accessories": ["Home Accessories", "Home & Garden > Decor"],
    "Heating": ["Heating Radiators"],
    "Lighting": ["Home & Garden > Lighting"],
    "Bathroom": ["Bathroom Accessories"]
  },
  "ðŸŒ³ Garden": {
    "Garden Tools": ["Garden Tools", "Deals > Tools and garden appliances"],
    "Barbecuing": ["Outdoor > Barbecues"]
  },
  "ðŸš— Automotive": {
    "Battery Care & Chargers": ["Battery Care & Chargers"],
    "Bodywork & Windscreen": ["Bodywork & Windscreen"],
    "Car Care & Car Cleaning": ["Car Care & Car Cleaning"],
    "Clips, O Rings, Pins & Springs": ["Clips, O Rings, Pins & Springs"],
    "Diagnostic & Electrics": ["Diagnostic & Electrics"],
    "Fluid Transfer": ["Fluid Transfer"],
    "Garage & Workshop": ["Garage & Workshop"],
    "Jacks, Lifting Gear & Stands": ["Jacks, Lifting Gear & Stands"],
    "Lubrication & Drainage": ["Lubrication & Drainage"],
    "Luggage, Recovery & Towing": ["Luggage, Recovery & Towing"],
    "Tarpaulins & Covers": ["Tarpaulins & Covers"],
    "Vehicle Repairs & Servicing": ["Vehicle Repairs & Servicing"]
  },
  "ðŸ Motorcycles": {
    "Womens Motorcycle Clothing": ["Motorcycle Clothing > Ladies"],
    "Mens Motorcycle Clothing": ["Motorcycle Clothing > Mens"],
    "Helmets": ["Motorcycle Helmets"]
  },
  "ðŸ… Sports & Outdoors": {
    "Cycling": ["Bike/APPAREL"],
    "Basketball": ["Basketball Gear"],
    "Football": ["Folding Football Goals"],
    "Swimming & Watersports": [
      "Outdoor > Swimming Pools",
      "Outdoor > Inflatable Kayaks",
      "Outdoor > Inflatable Loungers",
      "Outdoor > Inflatable Stand Up Paddle Boards"
    ],
    "Golf": ["Golf"],
    "Fitness": ["Heart Rate Monitor", "Medicine Balls", "Ab Belts", "Ab Benches", "Ab Crunchers", "Ab Exercisers", "Ab Straps", "Ab Wheels", "Default/Run/APPAREL", "Default/Run/EQUIPMENT", "Exercise Bikes", "Exercise Mats"],
    "Ski & Wintersports: ["SKI/WINTERSPORTS"]
  },
  "ðŸŽ¨ Arts & Crafts": {
    "Crafts & Sewing": ["Crafts & Sewing"],
    "Martha Stewart Crafts": ["Martha Stewart Crafts"],
    "Marianne Design": ["Marianne Design"],
    "Pens & Pencils": ["Marabu"],
    "Mediums & Finishes": ["Mediums & Finishes"]
  },
  "ðŸŒ Travel": {
    "London Day Out": ["London"],
    "Luggage & Bags": [
      "Luggage & Bags > Backpacks",
      "Luggage & Bags > Duffel Bags",
      "Luggage & Bags > Cosmetic & Toiletry Bags"
    ],
    "Kids Travel Bottles": ["Men > Women > Children > Baby & children products > Training & fitness"],
    "Travel Accessories": ["Travel accessories"]
  }
};

function fetchProducts(page = 1) {
  const url = `https://evening-basin-64817-f38e98d8c5e2.herokuapp.com/products.json?page=${page}&limit=${itemsPerPage}`;
  fetch(url)
    .then(res => res.json())
    .then(data => {
      allProducts = data;
      populateCategoryDropdown();
      applyFilters();
    })
    .catch(err => console.error("Error fetching products:", err));
}

function populateCategoryDropdown() {
  const select = document.getElementById("categoryFilter");
  select.innerHTML = '<option value="">Filter by Category</option>';
  Object.entries(categoryKeywords).forEach(([main, subs]) => {
    const optGroup = document.createElement("optgroup");
    optGroup.label = main;
    Object.entries(subs).forEach(([sub, keywords]) => {
      const opt = document.createElement("option");
      opt.value = keywords[0];
      opt.textContent = sub;
      optGroup.appendChild(opt);
    });
    select.appendChild(optGroup);
  });
}

function applyFilters() {
  const keyword = document.getElementById("searchInput").value.toLowerCase();
  const selectedCategory = document.getElementById("categoryFilter").value;

  filteredProducts = allProducts.filter(p => {
    const text = `${p.name} ${p.category}`;
    const matchKeyword = !keyword || text.toLowerCase().includes(keyword);
    const matchCategory = !selectedCategory || (p.category && p.category.includes(selectedCategory));
    return matchKeyword && matchCategory;
  });

  currentPage = 1;
  paginateValidProducts();
  displayProducts();
  renderPagination();
}

document.getElementById("searchInput").addEventListener("input", applyFilters);
document.getElementById("categoryFilter").addEventListener("change", applyFilters);

  let paginatedProducts = [];

function paginateValidProducts() {
  const valid = filteredProducts.filter(p =>
    p.image && p.link && p.image.startsWith("http") && p.link.startsWith("http")
  );

  paginatedProducts = [];
  for (let i = 0; i < valid.length; i += itemsPerPage) {
    const page = valid.slice(i, i + itemsPerPage);
    if (page.length === itemsPerPage || i + itemsPerPage >= valid.length) {
      paginatedProducts.push(page);
    } else {
      const remaining = valid.length - i;
      paginatedProducts.push(valid.slice(i)); // final smaller page
      break;
    }
  }
}

function displayProducts() {
  const container = document.getElementById("productContainer");
  container.innerHTML = "";

  const pageProducts = paginatedProducts[currentPage - 1] || [];

  pageProducts.forEach(p => {
    const div = document.createElement("div");
    div.className = "product";

    const img = document.createElement("img");
    img.src = p.image;
    img.alt = p.name;
    img.onerror = function () {
  handleImageError(p, this); // Logs and removes
};

    const title = document.createElement("h3");
    title.textContent = p.name;

    const link = document.createElement("a");
    link.href = p.link;
    link.target = "_blank";
    link.textContent = "View Product";

    div.appendChild(img);
    div.appendChild(title);
    div.appendChild(link);
    container.appendChild(div);
  });
}

function renderPagination() {
  const pagination = document.getElementById("paginationControls");
  pagination.innerHTML = "";

  const totalPages = paginatedProducts.length;
  if (totalPages <= 1) return;

  const maxVisible = 5;

  const createButton = (label, page, disabled = false, active = false) => {
    const btn = document.createElement("button");
    btn.textContent = label;
    if (disabled) btn.disabled = true;
    if (active) btn.classList.add("active");
    btn.onclick = () => {
      currentPage = page;
      displayProducts();
      renderPagination();
    };
    return btn;
  };

  pagination.appendChild(createButton("Prev", currentPage - 1, currentPage === 1));

  const pageList = [];

  if (totalPages <= maxVisible + 2) {
    for (let i = 1; i <= totalPages; i++) pageList.push(i);
  } else {
    pageList.push(1);

    const start = Math.max(2, currentPage - 1);
    const end = Math.min(totalPages - 1, currentPage + 1);

    if (start > 2) pageList.push("...");
    for (let i = start; i <= end; i++) pageList.push(i);
    if (end < totalPages - 1) pageList.push("...");
    pageList.push(totalPages);
  }

  pageList.forEach(p => {
    if (p === "...") {
      const span = document.createElement("span");
      span.textContent = "...";
      span.className = "ellipsis";
      pagination.appendChild(span);
    } else {
      pagination.appendChild(createButton(p, p, false, p === currentPage));
    }
  });

  pagination.appendChild(createButton("Next", currentPage + 1, currentPage === totalPages));
}

fetchProducts();

// Unmapped Download
  document.getElementById("downloadUnmapped").addEventListener("click", () => {
  const usedCategories = new Set(allProducts.map(p => p.category).filter(Boolean));

  const mappedCategories = new Set();
  Object.values(categoryKeywords).forEach(main => {
    Object.values(main).forEach(subs => {
      subs.forEach(cat => mappedCategories.add(cat));
    });
  });

  const unmatched = Array.from(usedCategories).filter(cat =>
    !Array.from(mappedCategories).some(mapped => cat.includes(mapped))
  );

  if (unmatched.length === 0) {
    alert("âœ… All categories appear to be mapped!");
    return;
  }

  const blob = new Blob(
    [unmatched.sort().join('\n')],
    { type: "text/plain;charset=utf-8" }
  );

  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "unmapped_categories.txt";
  link.click();
});

  let brokenProducts = [];

function handleImageError(product, element) {
  // Prevent duplicates
  if (!brokenProducts.find(p => p.name === product.name)) {
    brokenProducts.push(product);
  }
  element.closest(".product").remove();
}

function downloadBrokenProducts() {
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(brokenProducts, null, 2));
  const a = document.createElement('a');
  a.setAttribute("href", dataStr);
  a.setAttribute("download", "broken-products.json");
  a.click();
}

// Add download button
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.createElement("button");
  btn.textContent = "ðŸ“¦ Download Broken Products";
  btn.style.cssText = "margin: 20px auto; display: block; padding: 10px 15px; background-color: crimson; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;";
  btn.onclick = downloadBrokenProducts;
  document.body.insertBefore(btn, document.getElementById("productContainer"));
});
</script>
</body>
</html>
